import json
from io import StringIO

import scrapy
from scrapy import FormRequest
from scrapy.shell import inspect_response
from scrapy_playwright.page import PageMethod


class CuckooSpider(scrapy.Spider):
    name = "cuckoo"
    allowed_domains = ["cuckoo.cert.ee"]

    # start_urls = ["http://test.com/"]

    def start_requests(self):
        yield scrapy.Request(
            url="https://cuckoo.cert.ee/analysis/3967929/export/"
        )

    def parse(self, response):
        # self.state['items_count'] = self.state.get('items_count', 0) + 1
        # self.state['starting_id'] = response.css('table#recent tbody tr td strong::text').get()
        token = response.css("form input[name=csrfmiddlewaretoken]::attr(value)").extract_first()
        print(token)

        # headers = {
        #
        # }

        # "Content-Type": "multipart/form-data",
        # "Content-Length": 280,
        # "Accept-Encoding": "gzip, deflate, br",
        # 			"Cache-Control": "no-cache",
        # 			"Connection": "keep-alive",
        # "Host": "cuckoo.cert.ee",
        # "Referer": "https://cuckoo.cert.ee/analysis/3967929/export/"

        formdata = {
            "csrfmiddlewaretoken": token,
            "dirs": "reports"
        }

        request = FormRequest(url="https://cuckoo.cert.ee/analysis/3967929/export/",
                              formdata=formdata,
							  method='POST',
                              callback=self.parse_file)

        # request = FormRequest.from_response(response,
        #								formdata=formdata,
        #								#headers=headers,
        #								dont_click=True,
        #								#body=json.dumps(formdata),
        #								callback=self.parse_file)

        yield request

    def parse_file(self, response):
        with open("3967929-2.zip", "wb") as zip_file:
            zip_file.write(response.body)
