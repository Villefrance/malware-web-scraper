import json
import sys

matching_sha_list = {}

with open(sys.argv[3], "w") as output_file:
    output_file.write("[\n")

with open(sys.argv[2], "r") as cuckoo_file:
    cuckoo_data = json.load(cuckoo_file)
    cuckoo_sha_dict = {}
    i = 0
    for cuckoo_sample in cuckoo_data:
        if "sha256" in cuckoo_sample:
            if cuckoo_sample["sha256"] != "":
                cuckoo_sha_dict[cuckoo_sample["sha256"]] = cuckoo_sample["signatures"]
            #print(cuckoo_sha_dict)

    with open(sys.argv[1], "r") as cape_file:
        cape_data = json.load(cape_file)

        for cape_sample in cape_data:
            if cape_sample["sha256"] in cuckoo_sha_dict:
                i += 1
                data_set = {"sha256": cape_sample["sha256"], "cape_signatures": cape_sample["signatures"],
                            "cuckoo_signatures": cuckoo_sha_dict[cape_sample["sha256"]]}
                with open(sys.argv[3], "a") as output_file:
                    json.dump(data_set, output_file)
                    output_file.write(",\n")
                #print("matching sample hash found... cape: {} - cuckoo: {}".format(json.dumps(cape_sample["sha256"])
                #                                                                , json.dumps(cuckoo_sample["sha256"])))
                #print("comparing signatures... cape: {} - cuckoo: {}".format(
                #    len(cape_sample["signatures"]),
                #    len(cuckoo_sample["signatures"])
                #))

with open(sys.argv[3], 'rb+') as f: # removing the last two characters, to avoid having a comma too much in the end
    f.seek(-2, 2)                   # after the last item
    f.truncate()

with open(sys.argv[3], "a") as output_file:
    output_file.write("\n]")
