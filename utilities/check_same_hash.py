import json
import sys
import progressbar

with open(sys.argv[3], "w") as output_file:
    output_file.write("[\n")

with open(sys.argv[2], "r") as cuckoo_file:
    cuckoo_data = json.load(cuckoo_file)
    cuckoo_sha_dict = {}
    i = 0
    with progressbar.ProgressBar(max_value=len(cuckoo_data), redirect_stdout=True) as bar:
        print("Extracting Cuckoo samples...")
        for cuckoo_sample in cuckoo_data:
            i += 1
            bar.update(i)
            if "sha256" in cuckoo_sample:
                if cuckoo_sample["sha256"] != "":
                    cuckoo_sha_dict[cuckoo_sample["sha256"]] = cuckoo_sample["signatures"]
        print("Done extracting Cuckoo samples...")
    with open(sys.argv[1], "r") as cape_file:
        cape_data = json.load(cape_file)
        j = 0
        print("Comparing Cape samples with Cuckoo samples...")
        with progressbar.ProgressBar(max_value=len(cape_data), redirect_stdout=True) as bar:
            for cape_sample in cape_data:
                j += 1
                bar.update(j)
                if cape_sample["sha256"] in cuckoo_sha_dict:
                    data_set = {"sha256": cape_sample["sha256"], "cape_signatures": cape_sample["signatures"],
                                "cuckoo_signatures": cuckoo_sha_dict[cape_sample["sha256"]]}
                    with open(sys.argv[3], "a") as output_file:
                        json.dump(data_set, output_file)
                        output_file.write(",\n")
        print("Done.")

with open(sys.argv[3], 'rb+') as f: # removing the last two characters, to avoid having a comma too much in the end
    f.seek(-2, 2)                   # after the last item
    f.truncate()

with open(sys.argv[3], "a") as output_file:
    output_file.write("\n]")
