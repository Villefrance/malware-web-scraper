import csv
import json
import ntpath
import os
import sys

file_categories = ['antisandbox_', 'antivm_']
cuckoo_evasion_signatures = []
cape_evasion_signatures = []
evasion_signatures_in_both = []

os.chdir(sys.argv[1])
for cuckoo_signature_file in os.listdir(sys.argv[1]): # checking Cuckoo windows dir
    if cuckoo_signature_file.startswith(tuple(file_categories)) and cuckoo_signature_file.endswith(".py"):
        filepath = os.path.abspath(cuckoo_signature_file)
        filename = ntpath.basename(filepath)
        cuckoo_evasion_signatures.append(filename.split(".py")[0])

os.chdir(sys.argv[2])
for cuckoo_signature_file in os.listdir(sys.argv[2]): # checking Cuckoo networks dir
    if cuckoo_signature_file.startswith(tuple(file_categories)) and cuckoo_signature_file.endswith(".py"):
        filepath = os.path.abspath(cuckoo_signature_file)
        filename = ntpath.basename(filepath)
        cuckoo_evasion_signatures.append(filename.split(".py")[0])

os.chdir(sys.argv[3])
for cape_signature_file in os.listdir(sys.argv[3]): # checking Cape signatures dir
    if cape_signature_file.startswith(tuple(file_categories)) and cape_signature_file.endswith(".py"):
        filepath = os.path.abspath(cape_signature_file)
        filename = ntpath.basename(filepath)
        cape_evasion_signatures.append(filename.split(".py")[0])

print("Cuckoo evasion signatures: {}".format(cuckoo_evasion_signatures))
print("Cape evasion signatures: {}".format(cape_evasion_signatures))

for signature in cuckoo_evasion_signatures:
    if signature in cape_evasion_signatures:
        evasion_signatures_in_both.append(signature)

print("Evasion signatures in both: {}".format(evasion_signatures_in_both))

cuckoo_evasion_signatures_count = {}
cape_evasion_signatures_count = {}

with open(sys.argv[4], "r") as matching_signatures_file:
    samples = json.load(matching_signatures_file)
    for sample in samples:
        for signature in cuckoo_evasion_signatures:
            if signature in sample['cuckoo_signatures']:
                if signature in cuckoo_evasion_signatures_count:
                    cuckoo_evasion_signatures_count[signature] += 1
                    #cuckoo_evasion_signatures_count[signature].append(sample['sha256'])
                else:
                    cuckoo_evasion_signatures_count[signature] = 1
                    #cuckoo_evasion_signatures_count[signature] = [sample['sha256']]

        for signature in cape_evasion_signatures:
            if signature in sample['cape_signatures']:
                if signature in cape_evasion_signatures_count:
                    cape_evasion_signatures_count[signature] += 1
                    # cape_evasion_signatures_count[signature].append(sample['sha256'])
                else:
                    cape_evasion_signatures_count[signature] = 1
                    # cape_evasion_signatures_count[signature] = [sample['sha256']]

    print("Cuckoo evasion signatures count: {}".format(cuckoo_evasion_signatures_count))
    print("Cape evasion signatures count: {}".format(cape_evasion_signatures_count))

for signature in evasion_signatures_in_both:
    if signature in cuckoo_evasion_signatures_count and signature in cape_evasion_signatures_count:
        print("Both - Signature: {} - Cuckoo count: {} - Cape count: {}".format(signature, cuckoo_evasion_signatures_count[signature],
                                                                         cape_evasion_signatures_count[signature]))

for signature in cuckoo_evasion_signatures:
    if signature not in evasion_signatures_in_both or \
            (signature in evasion_signatures_in_both and signature not in cape_evasion_signatures_count):
        if signature in cuckoo_evasion_signatures_count:
            print("Cuckoo only - Signature: {} - Cuckoo count: {}".format(signature, cuckoo_evasion_signatures_count[signature]))
        else:
            print("Cuckoo only - Signature: {} - Cuckoo count: {}".format(signature, 0))
    #else:
    #    print("Cuckoo evasion signature {} found in both".format(signature))

for signature in cape_evasion_signatures:
    if signature not in evasion_signatures_in_both or \
            (signature in evasion_signatures_in_both and signature not in cuckoo_evasion_signatures_count):
        if signature in cape_evasion_signatures_count:
            print("Cape only - Signature: {} - Cape count: {}".format(signature, cape_evasion_signatures_count[signature]))
        else:
            print("Cape only - Signature: {} - Cape count: {}".format(signature, 0))

print("Cuckoo signatures total: {} - signatures over 0: {}".format(len(cuckoo_evasion_signatures),
                                                                   len(cuckoo_evasion_signatures_count)))
print("Cape signatures total: {} - signatures over 0: {}".format(len(cape_evasion_signatures),
                                                                 len(cape_evasion_signatures_count)))

print("cuckoo_evasion_signatures_count: {}".format(cuckoo_evasion_signatures_count))
print("cape_evasion_signatures_count: {}".format(cape_evasion_signatures_count))