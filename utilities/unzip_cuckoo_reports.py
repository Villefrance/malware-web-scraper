import os
import sys
import signal
from zipfile import ZipFile
import ntpath

do_process = True
sigint_count = 0

def signal_handler(sig, frame):
    global do_process
    global sigint_count
    if sigint_count == 0:
        print("Received sigint once... Exiting gracefully...")
        do_process = False
        sigint_count += 1
    else:
        print("Received sigint twice.. Forcing exit...")
        sys.exit(0)

signal.signal(signal.SIGINT, signal_handler)

os.chdir(sys.argv[1])
print("Extracting Cuckoo json reports from dir: " + sys.argv[1])
i = 1
listdir = os.listdir(sys.argv[1])
number_of_files = len(listdir)
print("Extracting {} files...".format(number_of_files))
errors = []
for item in os.listdir(sys.argv[1]): #input dir: ~/malware-web-scraper/malware/reports/cuckoo/zip/
    if do_process:
        if item.endswith(".zip"):
            filepath = os.path.abspath(item)
            with ZipFile(filepath) as zipfile:
                try:
                    zipinfo = zipfile.getinfo("reports/report.json")
                    filename = ntpath.basename(filepath) # Using ntpath instead of os to handle Windows style paths on Unix systems as well
                    zipinfo.filename = filename.split(".")[0] + ".json" #"3899577.json"
                    zipfile.extract(zipinfo, sys.argv[2]) # output dir: ~/malware-web-scraper/malware/reports/cuckoo/json/
                except KeyError:
                    print("Error: {} does not contain reports/report.json.. Skipping this file..".format(filename))
                    errors.append(filename)
                except:
                    print("Error: Something went wrong while trying to extract reports/report.json from {}.. Skipping this file..".format(filename))
                    errors.append(filename)
            if i % 100 == 0:
                print("Extracted {} out of {} files... {:.2}% done...".format(i, number_of_files, (i*100/number_of_files)))
            if i == number_of_files:
                if errors:
                    print("Failed to extract the following files: {}".format(errors))
                print("Done.. Extracted {} json files to dir: {}".format(number_of_files, sys.argv[1]))
            i += 1
    else:
        break
