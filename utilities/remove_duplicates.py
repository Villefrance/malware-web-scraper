import json
import sys
import time

from datetime import datetime
import progressbar

cape_potential_duplicates = {}
cape_duplicates = {}

with open(sys.argv[1], "r") as cape_file:
    cape_data = json.load(cape_file)
    j = 0
    print("Checking for duplicate Cape samples...")
    unique = {each['sha256']: each for each in cape_data}
    print("Unique samples: {}".format(len(unique)))
    with progressbar.ProgressBar(max_value=len(cape_data), redirect_stdout=True) as bar:
        for cape_sample in cape_data:
            j += 1
            bar.update(j)
            if cape_sample["sha256"] in cape_potential_duplicates:
                cape_potential_duplicates[cape_sample["sha256"]].append((cape_sample["analysis_url"], cape_sample["completed_at"]))
            else:
                cape_potential_duplicates[cape_sample["sha256"]] = [(cape_sample["analysis_url"], cape_sample["completed_at"])]

    print("Finding potential duplicates...")
    with progressbar.ProgressBar(max_value=len(cape_potential_duplicates), redirect_stdout=True) as bar:
        i = 1
        for potential_duplicate in cape_potential_duplicates:
            bar.update(i)
            if len(cape_potential_duplicates[potential_duplicate]) > 1:
                cape_duplicates[potential_duplicate] = cape_potential_duplicates[potential_duplicate]
            i += 1

    print("{} duplicate hashes found in Cape data".format(len(cape_duplicates)))

    newest_reports = {}
    print("Finding newest reports of duplicates...")
    with progressbar.ProgressBar(max_value=len(cape_duplicates), redirect_stdout=True) as bar:
        i = 1
        for hash in cape_duplicates:
            newest_report = ()
            #print(hash)
            for tuple in cape_duplicates[hash]:
                current_datetime = datetime.strptime(tuple[1], '%Y-%m-%d %H:%M:%S')
                if not newest_report or current_datetime > datetime.strptime(newest_report[1], '%Y-%m-%d %H:%M:%S'):
                    #print("found newer datetime... newest_report: {} - current_datetime: {}".format(newest_report,
                    #                                                                                current_datetime))
                    newest_report = tuple
                #else:
                    #print("datetime was not newer... newest_report: {} - current_datetime: {}".format(newest_report,
                    #                                                                                  current_datetime))
            newest_reports[hash] = newest_report
            bar.update(i)
            i += 1
            #if newest_report[0] in cape_data["analysis_url"]:
            #    print("found analysis_url based on newest_report for sha256: {}".format(cape_sample["sha256"]))

    print("hashes with duplicate reports: {}".format(len(newest_reports)))
    already_checked_duplicates = []
    print("Writing output file...")
    with progressbar.ProgressBar(max_value=len(cape_data), redirect_stdout=True) as bar:
        i = 1
        for cape_sample in cape_data:
            bar.update(i)
            data_set = {}
            if cape_sample["sha256"] in newest_reports:
                if cape_sample["sha256"] not in already_checked_duplicates:
                    if newest_reports[cape_sample["sha256"]][0] == cape_sample["analysis_url"]:
                        already_checked_duplicates.append(cape_sample["sha256"])
                        #print(cape_sample["sha256"])
                        data_set = cape_sample
            else:
                data_set = cape_sample

            with open(sys.argv[2], "a") as output_file:
                if i == 1:
                    output_file.write("[\n")
                if data_set:
                    json.dump(data_set, output_file)
                    if i < len(cape_data):
                        output_file.write(",\n")
                if i == len(cape_data):
                    output_file.write("\n]")
                i += 1
