import json
import sys
import progressbar

with open(sys.argv[1], "r") as file:
    signatures_amount = {}
    signature_count = {}

    reports = json.load(file)
    i = 0
    with progressbar.ProgressBar(max_value=len(reports), redirect_stdout=True) as bar:
        for report in reports:
            i += 1
            bar.update(i)
            signatures_amount[report["sha256"]] = len(report["signatures"])

            for signature in report["signatures"]:
                if signature in signature_count:
                    signature_count[signature] += 1
                else:
                    signature_count[signature] = 1

        #for signature in signature_count:
        #    if signature_count[signature] != len(matching_hashes):
        #        signature_count_not_all[signature] = signature_count[signature]
        #    else:
        #        signature_count_all[signature] = signature_count[signature]

                # if signature == "antivirus_virustotal":
                #    virustotal_signature_amount.append(matching_hash["sha256"])

        average_signatures = sum(signatures_amount.values()) / len(signatures_amount)
        #print("len(signatures_amount): {}".format(signatures_amount))

        sorted_signature_count = sorted(signature_count.items(), key=lambda x: x[1], reverse=True)  # [:5]
        #sorted_signature_count_not_all = sorted(signature_count_not_all.items(), key=lambda x: x[1],
        #                                             reverse=True)  # [:10]
        #sorted_signature_count_all = sorted(signature_count_all.items(), key=lambda x: x[1], reverse=True)

        print("Count of signatures: {}".format(sorted_signature_count))
        #print("Count of signatures (not all): {}".format(sorted_signature_count_not_all))
        #print("Count of signatures (all): {}".format(sorted_signature_count_all))

        print("Amount of unique signatures: {}".format(len(sorted_signature_count)))
        #print("Cape amount of unique signatures (not all): {}".format(len(sorted_signature_count_not_all)))
        #print("Cape amount of unique signatures (all): {}".format(len(sorted_signature_count_all)))

        # print("Cuckoo signatures amounts: {}".format(cuckoo_signatures_amount.values()))
        # print("Cape signatures amounts: {}".format(signatures_amount.values()))

        #print("Average Cuckoo signatures: {}".format(average_cuckoo_signatures))
        print("Average signatures: {}".format(average_signatures))
        #print("Average Cape signatures (not all): {}".format(average_signatures))