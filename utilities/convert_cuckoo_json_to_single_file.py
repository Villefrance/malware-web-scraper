import json
import os
import sys
from datetime import datetime

os.chdir(sys.argv[1])
print("Converting Cuckoo json reports to single file from dir: " + sys.argv[1])
i = 1
listdir = os.listdir(sys.argv[1])
number_of_files = len(listdir)
print("Converting {} files...".format(number_of_files))
result = {}
with open(sys.argv[2], "a") as output_file:
    output_file.write("[\n")
for item in os.listdir(sys.argv[1]): #input dir: /Users/fyxe/IdeaProjects/malware-web-scraper/malware/reports/cuckoo/zip/
    if item.endswith(".json"):
        filepath = os.path.abspath(item)
        with open(filepath, "r") as file:
                #print("file: {}".format(filepath))
            try:
                data = json.load(file)
                sha256 = data["target"]["file"]["sha256"] if "sha256" in data["target"]["file"] else ""
                url = "https://cuckoo.cert.ee/analysis/{}/".format(data["info"]["id"])
                completed_at = datetime.fromtimestamp(data["info"]["ended"]).strftime("%Y-%m-%d %H:%M:%S")
                signatures = []
                if data["signatures"]:
                    for signature in data["signatures"]:
                        if "name" in signature:
                            signatures.append(signature["name"])
                data_set = {"sha256": sha256, "url": url, "completed_at": completed_at, "signatures": signatures}
                #print(json.dumps(data_set))
                with open(sys.argv[2], "a") as output_file:
                    json.dump(data_set, output_file)
                    output_file.write(",\n")
            except:
                print("Error converting {}... Skipping this file...".format(filepath))
        if i % 100 == 0:
            print("Converted {} out of {} files... {:.2}% done...".format(i, number_of_files, (i*100/number_of_files)))
        i += 1
with open(sys.argv[2], "a") as output_file:
    output_file.write("]")
